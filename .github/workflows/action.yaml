name: action
on:
  push:
    branches: [main]
  schedule:
    - cron:  '0 0 * * *'
  pull_request:
jobs:
  lint:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: hadolint for controller
        run: docker run -e "HADOLINT_IGNORE=DL3008" --rm -i hadolint/hadolint < controller/Dockerfile
      - name: hadolint for compute
        run: docker run -e "HADOLINT_IGNORE=DL3008" --rm -i hadolint/hadolint < compute/Dockerfile
  test:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: Init docker-compose
        run: |
          docker-compose --file docker-compose.build.yaml up -d
          sleep 1800
      - name: Build Images
        run: |
          docker-compose --file docker-compose.build.yaml logs -t --tail=100
          docker-compose --file docker-compose.build.yaml exec -T --user stack controller /bin/test.bash
          for c in controller compute-1 compute-2; do
            docker-compose --file docker-compose.build.yaml exec -T $c /bin/bash -c /bin/pre-commit.bash
          done
          docker-compose --file docker-compose.build.yaml stop
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Push to Docker Hub for PR
        if: github.ref != 'refs/heads/main' && github.event_name != 'schedule'
        run: |
          for c in controller compute-1 compute-2; do
            docker commit $c bobuhiro11/containerized-devstack-$c:${{ github.sha }}
            docker push bobuhiro11/containerized-devstack-$c:${{ github.sha }}
          done
      - name: Push to Docker Hub for latest
        if: github.ref == 'refs/heads/main' && github.event_name != 'schedule'
        run: |
          for c in controller compute-1 compute-2; do
            docker commit $c bobuhiro11/containerized-devstack-$c:latest
            docker push bobuhiro11/containerized-devstack-$c:latest
          done
