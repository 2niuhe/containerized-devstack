name: action
on:
  push:
    branches: [main]
  schedule:
    - cron:  '0 0 * * *'
  pull_request:
jobs:
  lint:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: hadolint for controller
        run: docker run -e "HADOLINT_IGNORE=DL3008" --rm -i hadolint/hadolint < controller/Dockerfile
      - name: hadolint for compute
        run: docker run -e "HADOLINT_IGNORE=DL3008" --rm -i hadolint/hadolint < compute/Dockerfile
  test:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: Init docker-compose
        run: |
          docker-compose up -d
          sleep 1800
      - name: Exec OpenStack CLI
        run: |
          docker-compose logs -t --tail=100
          docker-compose exec -T --user stack controller /bin/bash -c \
            'source devstack/openrc admin admin; openstack compute service list'
          net_id=$(docker-compose exec -T --user stack controller /bin/bash -c \
            'source devstack/openrc admin admin >/dev/null 2>&1; openstack network show private -f json 2>/dev/null | jq -r .id' | tr -d "\r\n")
          docker-compose exec -T --user stack controller /bin/bash -c \
            "source devstack/openrc admin admin; exec nova boot --image cirros-0.5.2-x86_64-disk --flavor m1.medium --nic net-id=$net_id testvm"
          sleep 10
          docker-compose exec -T --user stack controller /bin/bash -c \
            "source devstack/openrc admin admin; exec nova list"
          docker-compose exec -T --user stack controller /bin/bash -c \
            "source devstack/openrc admin admin; exec nova list" | grep ACTIVE
